SCAN	EQU	30H
D0	EQU	50H
D1	EQU	51H
D2	EQU	52H
D3	EQU	53H
D4	EQU	54H
D5	EQU	55H
D6	EQU	56H
D7	EQU	57H
WENDU	EQU	40H
ADDR	EQU	41H
ORG	0000H
SJMP	MAIN
ORG	0003H
LJMP	EINT0
ORG	000BH
LJMP	TIM0
ORG	0023H
LJMP	SERIALISR
ORG	0030H
MAIN:
	MOV	SP,#5FH
	MOV	SCON,#0F0H
	MOV	TMOD,#21H
	MOV	TH1,#0FDH
	MOV	TL1,#0FDH
	SETB	TR1
;------------------------
	MOV	TH0,#3CH
	MOV	TL0,#0B0H
	SETB	EA
	SETB	ES
	SETB	SM2
	SETB	EX0
;	SETB	PX0
	SETB	IT0
	SETB	ET0
;	SETB	PS
;------------------------
	MOV	WENDU,#00H
	MOV	A,#00H
	MOV	R2,#00H	
	MOV	R0,#00H
	MOV	R3,#00H
	MOV	ADDR,#00H
LOOP: 
	LCALL LED
	LCALL DISP
	JMP LOOP
LED:
	MOV R2,ADDR
	MOV A,WENDU
	MOV B,#0AH
	DIV AB
	MOV R1,B
	MOV B,#0AH
	DIV AB
	MOV D0,R2
	MOV D1,#10H
	MOV D2,#10H
	MOV D3,#10H
	MOV D4,#10H
	MOV D5,A
	MOV D6,B
	MOV D7,R1
	RET
DISP:
	PUSH DPH
	PUSH DPL
	PUSH PSW
	PUSH ACC
	MOV R0,#D0
	MOV SCAN,#0FEH
LD0:
	MOV P0,#0FFH
	SETB P2.6
	NOP
	CLR P2.6
	MOV DPTR,#TABLE
	MOV A,@R0
	MOVC A,@A+DPTR
	MOV P0,A
	SETB P2.5
	NOP
	CLR P2.5
	MOV A,SCAN
	MOV P0,A
	SETB P2.6
	NOP
	CLR P2.6

	INC R0
	MOV A,SCAN
	JNB ACC.7,LD1
	RL A
	MOV SCAN,A
	AJMP LD0
LD1:
	MOV P0,#00
	SETB P2.5
	NOP
	CLR P2.5
	MOV P0,#0FFH
	SETB P2.6
	NOP
	CLR P2.6
	POP ACC
	POP PSW
	POP DPL
	POP DPH
	RET


;----------------------------------


EINT0:
	CPL	TR0
	RETI

TIM0:
	PUSH	ACC

	INC	R3
	CJNE	R3,#20,RET0
	MOV	R3,#00H
	LCALL	SEND
	
	INC	ADDR
	MOV	A,ADDR
	CJNE	A,#02H,RET0
	MOV	ADDR,#00H

RET0:

	POP	ACC
	RETI

SEND:
	SETB	TB8
	MOV	A,ADDR
	MOV	SBUF,A
	RET
;-------------------------------------
SERIALISR:
	PUSH	ACC
	JNB 	TI, RECV 
	CLR 	TI

	SJMP 	SEXIT
RECV:	
	MOV 	A,SBUF
	MOV	WENDU,A
	LCALL	DAC
	CLR 	RI
SEXIT:
	
	POP	ACC
	RETI		
;----------------------------------
DAC:
	CLR	P2.2
	MOV 	A,WENDU
	MOV 	B,#02H
	DIV AB
	MOV	P1,A
	SETB P2.3
	NOP 
	CLR P2.3
	RET

;--------------------------------------	
TABLE:
	DB 3FH,06H,5BH,4FH,66H
	DB 6DH,7DH,07H,7FH,6FH
	DB 77H,7CH,39H,5EH,79H
	DB 71H,00H,76H,38H,40H
DELAY:
	PUSH	00H
	PUSH	01H
	MOV	R0,#01H
DELAY1:
	MOV	R1,#00H
	DJNZ	R1,$
	DJNZ	R0,DELAY1
	POP	01H
	POP	00H
	RET	
END
